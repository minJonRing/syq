<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/stylesheets/style.css">
    <link rel="stylesheet" href="/stylesheets/table.css">
    <style>
        html,
        body {
            height: 100%;
        }
    </style>
    <script src="/javascripts/Vue.js"></script>
    <script src="/javascripts/jquery-3.3.1.min.js"></script>
    <script src="/release/wangEditor.min.js"></script>
    <script src="../release/wangEditor.min.js"></script>
</head>

<body>
    <div id="app">
        <div v-if="!isShow">
            <div class="title">
                <p>新闻列表</p>
                <a class="btn1" href="javascript:" @click="bindFindOneWork($event,{type:''})">全部</a>
                <a class="btn1" href="javascript:" v-for="(item,index) in types" :key="index" @click="bindFindOneWork($event,{type:item})">{{item}}</a>
                <a class="btn4" href="javascript:" @click="bindNewWork">新增</a>
            </div>
            <div class="table-box" border="0">
                <table>
                    <tr>
                        <th>类型</th>
                        <th>时间</th>
                        <th>标题</th>
                        <th>浏览量</th>
                        <th>操作</th>
                    </tr>
                    <tr v-for="(item,index) in copyList" :key="index">
                        <td>{{item.type}}</td>
                        <td>{{item.createtime.replace(/T.+/g,"")}}</td>
                        <td>{{item.title}}</td>
                        <td>{{item.browse}}</td>
                        <td>
                            <a class="edit" href="javascript:" @click="bindEditWork($event,{id:item._id})">编辑</a>
                            <a class="remove" href="javascript:" @click="bindRemoveWork($event,{id:item._id})">删除</a>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="pages">
                <a href="javascript:" :class="{'active':page == index}" v-for="(item,index) in pages" :key="item" @click.stop="bindLinkPage($event,index)">{{item}}</a>
            </div>
        </div>
        <div v-if="isShow">
            <div class="title">
                <p>编辑/新增</p>
                <a class="btn4" href="javascript:" @click="isShow = false">返回</a>
            </div>
            <form>
                <div class="input-box">
                    <p>标题：</p>
                    <div class="select" @click="isShowType = !isShowType">
                        <span>{{type}}</span>
                        <ul :class="{'show':isShowType}">
                            <li v-for="(item,index) in types" :key="index" @click.stop="bindSelectType($event,item)">{{item}}</li>
                        </ul>
                    </div>

                </div>
                <div class="input-box">
                    <p>标题：</p>
                    <input type="text" v-model="title" placeholder="*标题">
                </div>
                <div class="input-box">
                    <p>封面：</p>
                    <input type="file" @change="bindCover($event)" placeholder="*封面" accept="image/gif, image/jpeg, image/png">
                </div>
                <img class="cover" v-if="cover" :src="cover" alt="">
                <p class="form-cont">正文内容</p>
                <div id="editor">

                </div>
                <a class="save" href="javascript:" @click="bindSave">保存</a>
            </form>
        </div>
    </div>
</body>
<script src="/web.config.js"></script>
<script>
    var E = window.wangEditor //使用编辑器

    var app = new Vue({
        el: "#app",
        data: {
            isShow: false,
            types: set_config.news_type,
            isShowType: false,
            // 
            type: set_config.news_type[0],
            id: 0,
            title: "",
            cover: "",
            // 
            list: [],
            copyList: [],
            pages: 1,
            page: 0

        },
        mounted() {
            // 获取作品列表
            this.bindGetList()
        },
        watch: {
            "isShow": function(val) {
                if (val) {
                    setTimeout(() => {
                        window.editor = new E('#editor') //创建编辑器对象
                        editor.customConfig.uploadImgServer = '/app/upload/img'; //上传地址路由
                        editor.customConfig.uploadFileName = 'imgs' //后端后去的name名称
                        editor.customConfig.uploadImgHooks = {
                            before: function(xhr, editor, files) {
                                // 图片上传之前触发
                                // xhr 是 XMLHttpRequst 对象，editor 是编辑器对象，files 是选择的图片文件

                                // 如果返回的结果是 {prevent: true, msg: 'xxxx'} 则表示用户放弃上传
                                // return {
                                //     prevent: true,
                                //     msg: '放弃上传'
                                // }
                                console.log(files)
                            }
                        }
                        editor.create() //wangEditor使用formData上传
                    }, 1);
                }
            },
            "page": function(val) {
                this.copyList = this.list.slice(val * 9, (val + 1) * 9)
            }
        },
        methods: {
            /**
             * 获取列表数据
             */
            bindGetList() {
                this.page = 0;
                $.ajax({
                    url: "/app/getWork",
                    type: "POST",
                    success: (res) => {
                        this.list = res.data;
                        this.pages = Math.ceil(this.list.length / 9);
                        this.copyList = this.list.slice(0, 9);
                    }
                })
            },
            /**
             * 新增作品
             */
            bindNewWork() {
                this.isShow = true;
                this.type = set_config.news_type[0];
                this.id = 0;
                this.title = "";
                this.cover = "";
                setTimeout(() => {
                    editor.txt.html("")
                }, 1);
            },
            /**
             * 编辑 作品
             */
            bindEditWork(event, db) {
                this.isShow = true;
                $.ajax({
                    url: "/app/getOneWork",
                    type: "POST",
                    data: {
                        id: db.id
                    },
                    success: (res) => {
                        this.id = res.data._id;
                        this.type = res.data.type;
                        this.title = res.data.title;
                        this.cover = res.data.cover;
                        editor.txt.html(res.data.cont)
                    }
                })
            },
            /**
             * 删除作品
             */
            bindRemoveWork(event, db) {
                $.ajax({
                    url: "/app/removeWork",
                    type: "POST",
                    data: {
                        id: db.id
                    },
                    success: (res) => {
                        this.bindGetList()
                    }
                })
            },
            /**
             * 按类型查找作品
             */
            bindFindOneWork(event, db) {
                this.page = 0;
                if (!db.type) {
                    this.bindGetList();
                    return;
                }
                $.ajax({
                    url: "/app/findOneWork",
                    type: "POST",
                    data: {
                        type: db.type
                    },
                    success: (res) => {
                        this.list = res.data;
                        this.pages = Math.ceil(this.list.length / 9);
                        this.copyList = this.list.slice(0, 9);
                    }
                })
            },
            /**
             * 跳页
             */
            bindLinkPage(event, index) {
                this.page = index;
            },
            /*
             *选择作品类型
             */
            bindSelectType(event, db) {
                this.type = db;
                this.isShowType = false;
            },
            /*
             *获取封面的base64 编码 赋值给cover 显示图片
             */
            bindCover(event) {
                let el = event.target;
                let render = new FileReader();
                render.readAsDataURL(el.files[0])
                render.onload = (e) => {
                    this.cover = e.target.result
                }
            },
            /*
             *保存编辑/新建的数据
             * */
            bindSave() {
                if (this.title && editor.txt.html()) {
                    let formData = new FormData()
                    formData.append("id", this.id)
                    formData.append("type", this.type)
                    formData.append("title", this.title)
                    formData.append("cover", document.querySelector("input[type=file]").files[0])
                    formData.append("cont", editor.txt.html())
                    $.ajax({
                        url: "/app/work/save",
                        type: "POST",
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: (res) => {
                            if (res.code == 200) {
                                this.isShow = false;
                                this.bindGetList()
                            }
                        }
                    })
                }
            }
        }
    })
</script>

</html>